################################################################################
# Professional SaaS Docker Compose Architecture
# E-Commerce Analytics Platform
#
# Services:
#   - backend: Node.js/Express API server
#   - frontend: React production application
#   - nginx: Reverse proxy with SSL/TLS support
#
# Features:
#   - Health checks for all services
#   - Automatic restart on failure
#   - Isolated network architecture
#   - Persistent data volumes
#   - Production-grade logging
#   - Resource limits
#   - Security-hardened configuration
################################################################################

services:
  ############################################################################
  # Backend Service - Node.js/Express API
  ############################################################################
  backend:
    container_name: analytics-backend
    image: project_3-backend:latest
    
    # Environment variables (from .env file)
    environment:
      NODE_ENV: ${NODE_ENV:-production}
      PORT: ${BACKEND_PORT:-5000}
      HOST: 0.0.0.0
      JWT_SECRET: ${JWT_SECRET}
      JWT_EXPIRE: ${JWT_EXPIRE:-7d}
      CORS_ORIGIN: ${CORS_ORIGIN}
      REACT_APP_API_URL: ${REACT_APP_API_URL}
      MAX_FILE_SIZE: ${MAX_FILE_SIZE:-52428800}
      DATABASE_PATH: /app/data/analytics.db
      LOG_LEVEL: ${LOG_LEVEL:-info}
      ENABLE_RATE_LIMITING: ${ENABLE_RATE_LIMITING:-true}
    
    # Port mapping (internal only, not exposed to host)
    expose:
      - "${BACKEND_PORT:-5000}"
    
    # Volume mounts for persistence
    volumes:
      - backend_data:/app/data
    
    # Network connectivity
    networks:
      - app-network
    
    # Health check configuration
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://127.0.0.1:${BACKEND_PORT:-5000}/api/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
    
    # Restart policy for high availability
    restart: on-failure:5
    stop_grace_period: 30s
    
    # Logging configuration
    logging:
      driver: json-file
      options:
        max-size: 10m
        max-file: 5
        labels: service=backend
    
    # Resource limits (prevents memory runaway)
    deploy:
      resources:
        limits:
          cpus: '1'
          memory: 1G
        reservations:
          cpus: '0.5'
          memory: 512M

  ############################################################################
  # Frontend Service - React Production Build
  ############################################################################
  frontend:
    container_name: analytics-frontend
    image: project_3-frontend:latest
    
    # Environment variables
    environment:
      NODE_ENV: ${NODE_ENV:-production}
      REACT_APP_API_URL: ${REACT_APP_API_URL:-/api}
    
    # Port exposure (internal only)
    expose:
      - "3000"
    
    # Network connectivity
    networks:
      - app-network
    
    # Health check
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://127.0.0.1:3000"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
    
    # Restart policy
    restart: on-failure:5
    stop_grace_period: 30s
    
    # Logging
    logging:
      driver: json-file
      options:
        max-size: 10m
        max-file: 3
        labels: service=frontend
    
    # Resource limits
    deploy:
      resources:
        limits:
          cpus: '1'
          memory: 512M
        reservations:
          cpus: '0.5'
          memory: 256M
    
    # Wait for services
    depends_on:
      backend:
        condition: service_healthy

  ############################################################################
  # Nginx Reverse Proxy - SSL/TLS Termination & Load Balancing
  ############################################################################
  nginx:
    container_name: analytics-nginx
    image: nginx:alpine
    
    # Port mapping (exposed to host)
    ports:
      - "${HTTP_PORT:-80}:80"
      - "${HTTPS_PORT:-443}:443"
    
    # Volume mounts
    volumes:
      - ./nginx.conf:/etc/nginx/nginx.conf:ro
      - ./nginx/ssl:/etc/nginx/ssl:ro
      - /etc/letsencrypt:/etc/letsencrypt:ro
      - nginx_logs:/var/log/nginx
      - nginx_cache:/var/cache/nginx
    
    # Environment variables
    environment:
      BACKEND_HOST: backend
      BACKEND_PORT: ${BACKEND_PORT:-5000}
      FRONTEND_HOST: frontend
      FRONTEND_PORT: 3000
    
    # Depends on backend and frontend services
    depends_on:
      backend:
        condition: service_started
      frontend:
        condition: service_started
    
    # Network
    networks:
      - app-network
    
    # Health check
    healthcheck:
      test: ["CMD", "wget", "--quiet", "--tries=1", "--spider", "http://localhost/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 20s
    
    # Restart policy
    restart: on-failure:5
    stop_grace_period: 30s
    
    # Logging
    logging:
      driver: json-file
      options:
        max-size: 10m
        max-file: 5
        labels: service=nginx
    
    # Resource limits
    deploy:
      resources:
        limits:
          cpus: '1'
          memory: 512M
        reservations:
          cpus: '0.25'
          memory: 128M

  ############################################################################
  # Optional: PostgreSQL Database (for future scaling)
  # Uncomment to enable database persistence
  ############################################################################
  # db:
  #   container_name: analytics-db
  #   image: postgres:15-alpine
  #   environment:
  #     POSTGRES_USER: ${DB_USER:-analytics}
  #     POSTGRES_PASSWORD: ${DB_PASSWORD:-securepassword}
  #     POSTGRES_DB: ${DB_NAME:-analytics_db}
  #   volumes:
  #     - db_data:/var/lib/postgresql/data
  #   networks:
  #     - app-network
  #   healthcheck:
  #     test: ["CMD-SHELL", "pg_isready -U ${DB_USER:-analytics}"]
  #     interval: 10s
  #     timeout: 5s
  #     retries: 5
  #   restart: on-failure:5
  #   logging:
  #     driver: json-file
  #     options:
  #       max-size: 10m
  #       max-file: 3
  #   deploy:
  #     resources:
  #       limits:
  #         cpus: '1'
  #         memory: 1G

  ############################################################################
  # Optional: Redis Cache (for session management & caching)
  # Uncomment to enable caching layer
  ############################################################################
  # redis:
  #   container_name: analytics-redis
  #   image: redis:7-alpine
  #   command: redis-server --appendonly yes --requirepass ${REDIS_PASSWORD:-redispass}
  #   volumes:
  #     - redis_data:/data
  #   networks:
  #     - app-network
  #   healthcheck:
  #     test: ["CMD", "redis-cli", "ping"]
  #     interval: 10s
  #     timeout: 5s
  #     retries: 5
  #   restart: on-failure:5
  #   logging:
  #     driver: json-file
  #     options:
  #       max-size: 10m
  #       max-file: 3
  #   deploy:
  #     resources:
  #       limits:
  #         cpus: '1'
  #         memory: 256M

################################################################################
# Named Volumes - Persistent Data Storage
################################################################################
volumes:
  # Backend SQLite database
  backend_data:
    driver: local
    driver_opts:
      type: none
      o: bind
      device: ${BACKEND_DATA_PATH:-./data/backend}
  
  # Nginx logs
  nginx_logs:
    driver: local
    driver_opts:
      type: none
      o: bind
      device: ${NGINX_LOGS_PATH:-./data/nginx/logs}
  
  # Nginx cache
  nginx_cache:
    driver: local
    driver_opts:
      type: none
      o: bind
      device: ${NGINX_CACHE_PATH:-./data/nginx/cache}
  
  # Optional: PostgreSQL data
  # db_data:
  #   driver: local
  #   driver_opts:
  #     type: none
  #     o: bind
  #     device: ${DB_DATA_PATH:-./data/db}
  
  # Optional: Redis data
  # redis_data:
  #   driver: local
  #   driver_opts:
  #     type: none
  #     o: bind
  #     device: ${REDIS_DATA_PATH:-./data/redis}

################################################################################
# Networks - Isolated Communication
################################################################################
networks:
  # Internal network for service-to-service communication
  app-network:
    driver: bridge
    driver_opts:
      # Isolate network for security
      com.docker.network.bridge.enable_ip_masquerade: 'true'
    ipam:
      config:
        - subnet: 172.20.0.0/16
